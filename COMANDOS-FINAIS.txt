╔══════════════════════════════════════════════════════════════════╗
║           🔧 SOLUÇÃO FINAL - WEBHOOK WHATSAPP                    ║
║               PROBLEMA "403 FORBIDDEN" RESOLVIDO ✅              ║
╚══════════════════════════════════════════════════════════════════╝


┌──────────────────────────────────────────────────────────────────┐
│ 1. CONECTE AO SERVIDOR                                           │
└──────────────────────────────────────────────────────────────────┘

ssh -i "C:\Users\Ian_1\Documents\AtenMed\site-atenmed.pem" ubuntu@3.129.206.231


┌──────────────────────────────────────────────────────────────────┐
│ 2. NAVEGUE ATÉ O PROJETO                                         │
└──────────────────────────────────────────────────────────────────┘

cd /var/www/atenmed


┌──────────────────────────────────────────────────────────────────┐
│ 3. ATUALIZE O CÓDIGO (escolha uma opção)                         │
└──────────────────────────────────────────────────────────────────┘

# Opção A: Via Git (recomendado)
git pull origin reorganizacao-estrutura

# Opção B: Upload manual do server.js
# Use SCP ou WinSCP para enviar o arquivo atualizado


┌──────────────────────────────────────────────────────────────────┐
│ 4. REINICIE O SERVIDOR                                           │
└──────────────────────────────────────────────────────────────────┘

pm2 restart atenmed


┌──────────────────────────────────────────────────────────────────┐
│ 5. TESTE O WEBHOOK (deve retornar "TESTE_OK")                    │
└──────────────────────────────────────────────────────────────────┘

curl "http://localhost:3000/api/whatsapp/webhook?hub.mode=subscribe&hub.verify_token=atenmed_webhook_2025&hub.challenge=TESTE_OK"

✅ RESULTADO ESPERADO: TESTE_OK


┌──────────────────────────────────────────────────────────────────┐
│ 6. TESTE EXTERNO (com HTTPS)                                     │
└──────────────────────────────────────────────────────────────────┘

curl "https://atenmed.com.br/api/whatsapp/webhook?hub.mode=subscribe&hub.verify_token=atenmed_webhook_2025&hub.challenge=OK"

✅ RESULTADO ESPERADO: OK


┌──────────────────────────────────────────────────────────────────┐
│ 7. CONFIGURE NO META DEVELOPER                                   │
└──────────────────────────────────────────────────────────────────┘

📍 URL: https://developers.facebook.com/apps/

Configurações:
  • URL de callback: https://atenmed.com.br/api/whatsapp/webhook
  • Verificar token: atenmed_webhook_2025

👆 Clique em "Verificar e salvar"


╔══════════════════════════════════════════════════════════════════╗
║                    O QUE FOI CORRIGIDO                           ║
╚══════════════════════════════════════════════════════════════════╝

✅ Rate Limiter: Webhook agora está excluído do rate limiting
✅ Sanitização XSS: Desabilitada para webhooks (preserva parâmetros)
✅ CORS: Permitindo requisições sem origem (Meta pode acessar)
✅ Token: Configurado corretamente no .env


╔══════════════════════════════════════════════════════════════════╗
║                    DIAGNÓSTICO RÁPIDO                            ║
╚══════════════════════════════════════════════════════════════════╝

# Ver status do servidor
pm2 status

# Ver logs em tempo real
pm2 logs atenmed

# Verificar configuração atual
curl http://localhost:3000/api/whatsapp/debug-webhook

# Ver token configurado
grep WHATSAPP_VERIFY_TOKEN .env


╔══════════════════════════════════════════════════════════════════╗
║              SE AINDA DER ERRO 403 FORBIDDEN                     ║
╚══════════════════════════════════════════════════════════════════╝

1. Verificar se o servidor reiniciou:
   pm2 status

2. Ver logs do erro:
   pm2 logs atenmed --lines 50

3. Verificar Nginx:
   sudo systemctl status nginx
   sudo nginx -t

4. Testar diretamente na porta:
   curl http://localhost:3000/api/whatsapp/webhook?hub.mode=subscribe&hub.verify_token=atenmed_webhook_2025&hub.challenge=OK


╔══════════════════════════════════════════════════════════════════╗
║                         TOKEN CORRETO                            ║
╚══════════════════════════════════════════════════════════════════╝

WHATSAPP_VERIFY_TOKEN=atenmed_webhook_2025

⚠️  Use EXATAMENTE este token no Meta Developer!


╔══════════════════════════════════════════════════════════════════╗
║                   DOCUMENTAÇÃO COMPLETA                          ║
╚══════════════════════════════════════════════════════════════════╝

📖 SOLUCAO-FORBIDDEN-WEBHOOK.md  → Explicação detalhada do problema
📖 WEBHOOK-SETUP.md              → Guia visual completo
📖 TESTE-WEBHOOK-RAPIDO.md       → Teste local rápido


╔══════════════════════════════════════════════════════════════════╗
║                    QUANDO TUDO FUNCIONAR                         ║
╚══════════════════════════════════════════════════════════════════╝

Você verá nos logs:

📱 Tentativa de verificação de webhook WhatsApp
   Mode: subscribe
   Token recebido: atenmed_webhook_2025
   Token esperado: atenmed_webhook_2025
✅ Webhook verificado com sucesso

🎉 Pronto! O WhatsApp pode enviar mensagens para seu servidor!


