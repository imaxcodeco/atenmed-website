╔══════════════════════════════════════════════════════════════════════╗
║                                                                      ║
║      🎉 WEBHOOK WHATSAPP CONFIGURADO COM SUCESSO! 🎉                ║
║                                                                      ║
╚══════════════════════════════════════════════════════════════════════╝


┌──────────────────────────────────────────────────────────────────────┐
│                    ⚡ COMANDOS SUPER RÁPIDOS ⚡                      │
└──────────────────────────────────────────────────────────────────────┘


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📋 NO COMPUTADOR LOCAL (WINDOWS)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

# Testar webhook completo
npm run test-whatsapp

# Testar apenas verificação
npm run test-webhook-local

# Ver health check
curl.exe -s https://atenmed.com.br/api/whatsapp/health

# Testar webhook manualmente
curl.exe -s "https://atenmed.com.br/api/whatsapp/webhook?hub.mode=subscribe&hub.verify_token=atenmed_webhook_2025&hub.challenge=TESTE"


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🖥️ NO SERVIDOR AWS
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

# Conectar ao servidor
ssh -i "C:\Users\Ian_1\Documents\AtenMed\site-atenmed.pem" ubuntu@3.129.206.231

# Ir para o projeto
cd /var/www/atenmed

# Ver logs em tempo real
tail -f logs/combined.log

# Ver apenas erros
tail -f logs/error.log

# Ver status do PM2
~/.nvm/versions/node/$(ls ~/.nvm/versions/node | tail -1)/bin/pm2 status

# Ver logs do PM2
~/.nvm/versions/node/$(ls ~/.nvm/versions/node | tail -1)/bin/pm2 logs atenmed --lines 50

# Reiniciar servidor
~/.nvm/versions/node/$(ls ~/.nvm/versions/node | tail -1)/bin/pm2 restart atenmed

# Atualizar código do Git
git pull origin reorganizacao-estrutura
~/.nvm/versions/node/$(ls ~/.nvm/versions/node | tail -1)/bin/pm2 restart atenmed

# Ver variáveis de ambiente do WhatsApp
cat .env | grep WHATSAPP

# Testar webhook localmente no servidor
curl -s "http://localhost:3000/api/whatsapp/webhook?hub.mode=subscribe&hub.verify_token=atenmed_webhook_2025&hub.challenge=OK"


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🌐 META DEVELOPER CONSOLE
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

# URL do Console
https://developers.facebook.com/apps/

# Configuração do Webhook
WhatsApp → Configuração → Webhook

# Dados para configurar:
URL: https://atenmed.com.br/api/whatsapp/webhook
Token: atenmed_webhook_2025

# Campos para habilitar (Subscribe):
☑️ messages
☑️ message_status


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🧪 TESTES
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

# Health Check
curl.exe https://atenmed.com.br/api/whatsapp/health

# Verificação do Webhook
curl.exe "https://atenmed.com.br/api/whatsapp/webhook?hub.mode=subscribe&hub.verify_token=atenmed_webhook_2025&hub.challenge=TESTE123"

# Testar envio de mensagem (requer autenticação admin)
# Use Postman ou similar:
POST https://atenmed.com.br/api/whatsapp/send-test
Headers:
  Authorization: Bearer SEU_TOKEN_ADMIN
  Content-Type: application/json
Body:
{
  "phone": "5511999999999",
  "message": "Teste do AtenMed"
}


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔧 MANUTENÇÃO
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

# Backup do .env
cp .env .env.backup.$(date +%Y%m%d_%H%M%S)

# Ver espaço em disco
df -h

# Ver uso de memória
free -h

# Ver processos do Node
ps aux | grep node

# Limpar logs antigos (cuidado!)
# Não execute sem backup
# > logs/combined.log
# > logs/error.log


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📊 MONITORAMENTO
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

# Ver últimas 100 linhas do log
tail -100 logs/combined.log

# Procurar por erros
grep -i "error" logs/combined.log | tail -20

# Procurar mensagens do WhatsApp
grep "WhatsApp" logs/combined.log | tail -20

# Ver mensagens recebidas
grep "📨 Processando mensagem" logs/combined.log | tail -20

# Ver webhooks recebidos
grep "📬 Webhook recebido" logs/combined.log | tail -20


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🚨 SOLUÇÃO DE PROBLEMAS
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

# Servidor não responde
~/.nvm/versions/node/$(ls ~/.nvm/versions/node | tail -1)/bin/pm2 restart atenmed

# Ver se há erros no código
~/.nvm/versions/node/$(ls ~/.nvm/versions/node | tail -1)/bin/pm2 logs atenmed --err --lines 50

# Verificar se a porta 3000 está aberta
netstat -tulpn | grep 3000

# Verificar certificado SSL
sudo certbot certificates

# Renovar certificado SSL (se expirado)
sudo certbot renew
sudo systemctl restart nginx

# Verificar Nginx
sudo systemctl status nginx
sudo nginx -t

# Reiniciar Nginx
sudo systemctl restart nginx


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📁 ARQUIVOS IMPORTANTES
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

PROXIMO-PASSO-WHATSAPP.md        ← LEIA ESTE! Guia completo
COMANDOS-WHATSAPP-RAPIDOS.txt    ← Este arquivo
SOLUCAO-FORBIDDEN-WEBHOOK.md     ← Explicação técnica
test-whatsapp-completo.js        ← Script de teste
routes/whatsappV2.js             ← Rotas do webhook
services/whatsappServiceV2.js    ← Lógica do WhatsApp


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ CHECKLIST RÁPIDO
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

[✅] Webhook verificado pelo Meta
[ ] Campos habilitados (messages, message_status)
[ ] Teste automatizado executado (npm run test-whatsapp)
[ ] Primeira mensagem enviada via WhatsApp
[ ] Primeira mensagem recebida nos logs
[ ] Sistema de resposta automática configurado


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🎯 PRÓXIMOS PASSOS
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

1. ⏳ Habilitar campos no Meta (messages, message_status)
2. ⏳ Executar teste: npm run test-whatsapp
3. ⏳ Enviar primeira mensagem via WhatsApp
4. ⏳ Configurar respostas automáticas
5. ⏳ Testar fluxo de agendamento


╔══════════════════════════════════════════════════════════════════════╗
║                                                                      ║
║     🎉 SISTEMA PRONTO! CONTINUE PARA PRÓXIMO-PASSO-WHATSAPP.md     ║
║                                                                      ║
╚══════════════════════════════════════════════════════════════════════╝

