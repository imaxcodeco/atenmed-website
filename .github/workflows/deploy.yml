name: Deploy to Production

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --production

      - name: Build CSS
        run: npm run build:css || echo "Build CSS optional"

      - name: Create .env file
        run: |
          cat > .env << EOF
          NODE_ENV=production
          PORT=3000
          HOST=0.0.0.0

          # URLs
          APP_URL=https://atenmed.com.br
          CORS_ORIGIN=https://atenmed.com.br,https://www.atenmed.com.br

          # MongoDB
          MONGODB_URI=${{ secrets.MONGODB_URI }}

          # JWT
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          JWT_EXPIRES_IN=7d

          # Email (AWS SES)
          EMAIL_HOST=${{ secrets.EMAIL_HOST }}
          EMAIL_PORT=587
          EMAIL_USER=${{ secrets.EMAIL_USER }}
          EMAIL_PASS=${{ secrets.EMAIL_PASS }}
          EMAIL_FROM=${{ secrets.EMAIL_FROM }}

          # WhatsApp
          WHATSAPP_API_URL=https://graph.facebook.com/v18.0
          WHATSAPP_PHONE_ID=${{ secrets.WHATSAPP_PHONE_ID }}
          WHATSAPP_TOKEN=${{ secrets.WHATSAPP_TOKEN }}
          WHATSAPP_VERIFY_TOKEN=${{ secrets.WHATSAPP_VERIFY_TOKEN }}
          WHATSAPP_APP_SECRET=${{ secrets.WHATSAPP_APP_SECRET }}

          # Google Calendar
          GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
          GOOGLE_REDIRECT_URL=https://atenmed.com.br/api/auth/google/callback

          # Security
          BCRYPT_ROUNDS=12
          SESSION_SECRET=${{ secrets.SESSION_SECRET }}

          # Features
          ENABLE_REMINDERS=true
          ENABLE_WAITLIST=true
          ENABLE_WHATSAPP=true
          ENABLE_GOOGLE_CALENDAR=true
          EOF

      - name: Deploy to Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.EC2_PORT || 22 }}
          script: |
            set -e
            echo "ğŸ” Checking directory..."

            # ForÃ§ar usar /var/www/atenmed
            if [ ! -d "/var/www/atenmed" ]; then
              echo "âš ï¸ /var/www/atenmed nÃ£o existe, tentando criar..."
              sudo mkdir -p /var/www/atenmed
              sudo chown -R $USER:$USER /var/www/atenmed
            fi

            cd /var/www/atenmed
            echo "ğŸ“‚ DiretÃ³rio atual: $(pwd)"
            echo "ğŸ” Branch atual antes do pull: $(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo 'nÃ£o Ã© um repo git')"
            echo "ğŸ” Commit atual: $(git rev-parse --short HEAD 2>/dev/null || echo 'nÃ£o encontrado')"

            # Configurar git para usar HTTPS com Personal Access Token
            echo "ğŸ”‘ Configurando git para usar HTTPS com token..."

            # Configurar credential helper para evitar prompts
            git config --global credential.helper store || true

            # Preparar token para autenticaÃ§Ã£o HTTPS
            # Usar GITHUB_PAT se disponÃ­vel, caso contrÃ¡rio usar GITHUB_TOKEN
            GIT_TOKEN=""
            if [ -n "${{ secrets.GITHUB_PAT }}" ]; then
              GIT_TOKEN="${{ secrets.GITHUB_PAT }}"
              echo "âœ… Personal Access Token (PAT) disponÃ­vel"
            elif [ -n "${{ secrets.GITHUB_TOKEN }}" ]; then
              GIT_TOKEN="${{ secrets.GITHUB_TOKEN }}"
              echo "âœ… GitHub Token disponÃ­vel"
            else
              echo "âš ï¸ ATENÃ‡ÃƒO: Nenhum token configurado!"
              echo "âš ï¸ Configure GITHUB_PAT no GitHub Secrets para repositÃ³rios privados"
              echo "âš ï¸ Tentando sem autenticaÃ§Ã£o (pode falhar para repositÃ³rios privados)..."
            fi

            # Configurar remote para HTTPS
            REMOTE_URL=$(git remote get-url origin 2>/dev/null || echo "")

            if [ -d ".git" ]; then
              # RepositÃ³rio jÃ¡ existe, atualizar remote
              if [[ "$REMOTE_URL" == *"git@github.com"* ]] || [[ -z "$REMOTE_URL" ]]; then
                echo "ğŸ”„ Configurando remote para HTTPS..."
                if [ -n "$GIT_TOKEN" ]; then
                  git remote set-url origin https://${GIT_TOKEN}@github.com/imaxcodeco/atenmed-website.git
                else
                  git remote set-url origin https://github.com/imaxcodeco/atenmed-website.git
                fi
              fi
              
              echo "ğŸ”„ Fazendo pull via HTTPS..."
              # O remote jÃ¡ estÃ¡ configurado com o token na URL, entÃ£o apenas fazer fetch/pull
              git fetch origin || true
              git checkout main 2>/dev/null || git checkout master 2>/dev/null || echo "JÃ¡ na branch correta"
              git reset --hard origin/main 2>/dev/null || git reset --hard origin/master 2>/dev/null || true
            else
              echo "âš ï¸ NÃ£o Ã© um repo git, clonando via HTTPS..."
              cd /var/www
              sudo rm -rf atenmed
              if [ -n "$GIT_TOKEN" ]; then
                git clone https://${GIT_TOKEN}@github.com/imaxcodeco/atenmed-website.git atenmed
              else
                echo "âŒ ERRO: Token necessÃ¡rio para clonar repositÃ³rio privado"
                echo "âŒ Configure GITHUB_PAT no GitHub Secrets"
                exit 1
              fi
              cd atenmed
              git checkout main || git checkout master
              sudo chown -R $USER:$USER .
            fi

            echo "âœ… Commit apÃ³s pull: $(git rev-parse --short HEAD)"
            echo "ğŸ“‹ Ãšltimo commit: $(git log -1 --oneline)"

            # Backup
            mkdir -p backups
            cp .env backups/.env.$(date +%Y%m%d_%H%M%S) 2>/dev/null || true

            # Install dependencies
            echo "ğŸ“¦ Instalando dependÃªncias..."
            npm install --production --legacy-peer-deps --ignore-scripts

            # Build
            echo "ğŸ”¨ Fazendo build..."
            npm run build:css || echo "Build optional"

            # Verificar se arquivo existe
            echo "ğŸ” Verificando arquivos..."
            if [ -f "applications/ai-agents/index.html" ]; then
              echo "âœ… applications/ai-agents/index.html existe"
            else
              echo "âŒ applications/ai-agents/index.html NÃƒO existe!"
              ls -la applications/ai-agents/ || echo "DiretÃ³rio nÃ£o existe"
            fi

            # Restart with PM2
            echo "ğŸ”„ Reiniciando PM2..."
            pm2 restart atenmed --update-env || pm2 start ecosystem.config.js --env production
            pm2 save

            # Show status
            pm2 status
            echo "ğŸ“‹ Logs recentes:"
            pm2 logs atenmed --lines 20 --nostream || true

            echo "âœ… Deploy completed successfully!"

      - name: Health Check
        run: |
          sleep 10
          curl --fail https://atenmed.com.br/health || exit 1
          echo "âœ… Health check passed!"

      - name: Notify Success
        if: success()
        run: |
          echo "ğŸ‰ Deploy to atenmed.com.br successful!"
          echo "âœ… Application is running"
          echo "ğŸŒ URL: https://atenmed.com.br"

      - name: Notify Failure
        if: failure()
        run: |
          echo "âŒ Deploy failed!"
          echo "Check logs for details"
